name: PublishRelease - WinForms ClickOnce (MS3)

# PLEASE NOTE: PUBLISHING/DEPLOYMENT
#   * Release is to be created manually at GitHub releases management page
#     * release name usually contains "1.2.3.4" (also supported: "v1.2.3.4")
#   * After creating a GitHub release, following actions will automatically run:
#     * Creating ClickOnce manifests (MS3)
#     * Attaching a ClickOnce ZIP to GitHub release (for inspection / download)

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  #contents: write # needed for attaching assets to a release
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_CONFIGURATION: Release
  CLICKONCE_OUTDIR: artifacts/clickonce/anycpu
  # ClickOnce app display name (free text)
  CLICKONCE_APP_NAME: GuacamoleClient

jobs:
  winforms-clickonce:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Resolve version
        shell: bash
        run: |
          RAW_TAG="${{ github.event.release.tag_name }}"
          if [[ -z "$RAW_TAG" ]]; then
            VER="0.0.0.${{ github.run_number }}"
          else
            VER="${RAW_TAG#v}"
          fi
          echo "VERSION=$VER" >> "$GITHUB_ENV"
          echo "Resolved VERSION=$VER"

      - name: Resolve ClickOnce ProviderURL
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "CLICKONCE_PROVIDER_URL=https://jochenwezel.github.io/GuacamoleClient/clickonce/stable/" >> "$GITHUB_ENV"
            echo "PAGES_SUBDIR=clickonce/stable" >> "$GITHUB_ENV"
          else
            echo "CLICKONCE_PROVIDER_URL=https://jochenwezel.github.io/GuacamoleClient/clickonce/dev/" >> "$GITHUB_ENV"
            echo "PAGES_SUBDIR=clickonce/dev" >> "$GITHUB_ENV"
          fi

      - name: Restore Tools
        run: dotnet tool restore

      - name: Info Tools
        run: |
          dotnet tool list
          dotnet tool list -g
          dotnet --list-sdks
          dotnet --list-runtimes


      - name: Restore
        run: dotnet restore GuacamoleClient-WinForms/GuacamoleClient-WinForms.csproj

      # 1) Publish app payload (RID-less) into ClickOnce folder
      - name: Publish app payload (RID-less, framework-dependent)
        shell: pwsh
        run: |
          $out = Join-Path $env:GITHUB_WORKSPACE "${{ env.CLICKONCE_OUTDIR }}"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          dotnet publish .\GuacamoleClient-WinForms\GuacamoleClient-WinForms.csproj `
            -c $env:BUILD_CONFIGURATION `
            --self-contained false `
            -o $out `
            -p:Version=${{ env.VERSION }} `
            -p:FileVersion=${{ env.VERSION }} `
            -p:AssemblyVersion=${{ env.VERSION }} `
            -p:InformationalVersion=${{ env.VERSION }}

      # 2) Detect main EXE (robust) and store for subsequent steps
      - name: Detect main EXE
        shell: pwsh
        run: |
          $out = Join-Path $env:GITHUB_WORKSPACE "${{ env.CLICKONCE_OUTDIR }}"

          $exe = Get-ChildItem -Path $out -File -Filter *.exe |
            Where-Object { $_.Name -notmatch '(?i)vshost|apphost|createdump|dotnet|host|test' } |
            Sort-Object Length -Descending |
            Select-Object -First 1

          if (-not $exe) {
            throw "No suitable .exe found in $out"
          }

          "CLICKONCE_EXE_NAME=$($exe.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Detected EXE: $($exe.Name)"

      # 3) Create ClickOnce application manifest (*.exe.manifest)
      - name: Create ClickOnce application manifest (dotnet mage)
        shell: pwsh
        run: |
          $out = Join-Path $env:GITHUB_WORKSPACE "${{ env.CLICKONCE_OUTDIR }}"
          $exe = $env:CLICKONCE_EXE_NAME
          $appManifest = Join-Path $out "$exe.manifest"

          dotnet mage -New Application `
            -Name "${{ env.CLICKONCE_APP_NAME }}" `
            -Version "${{ env.VERSION }}" `
            -FromDirectory "$out" `
            -ToFile "$appManifest" `
            -Processor msil

          if (-not (Test-Path $appManifest)) { throw "Application manifest not created: $appManifest" }

          "CLICKONCE_APP_MANIFEST=$exe.manifest" | Out-File -Append $env:GITHUB_ENV

      # 4) Create ClickOnce deployment manifest (*.application)
      - name: Create ClickOnce deployment manifest (dotnet mage)
        shell: pwsh
        run: |
          $out = Join-Path $env:GITHUB_WORKSPACE "${{ env.CLICKONCE_OUTDIR }}"
          $appManifest = $env:CLICKONCE_APP_MANIFEST
          $deployManifest = Join-Path $out "${{ env.CLICKONCE_APP_NAME }}.application"

          dotnet mage -New Deployment `
            -Name "${{ env.CLICKONCE_APP_NAME }}" `
            -Version "${{ env.VERSION }}" `
            -AppManifest "$out\$appManifest" `
            -ToFile "$deployManifest" `
            -ProviderURL "${{ env.CLICKONCE_PROVIDER_URL }}" `
            -Install true

          if (-not (Test-Path $deployManifest)) { throw "Deployment manifest not created: $deployManifest" }

      # 5) Upload artifact for inspection
      - name: Pack ClickOnce output
        shell: pwsh
        run: |
          $src = Join-Path $env:GITHUB_WORKSPACE "${{ env.CLICKONCE_OUTDIR }}\*"
          $dst = Join-Path $env:GITHUB_WORKSPACE "bin-winforms-clickonce-${{ env.VERSION }}.zip"
          Compress-Archive -Path $src -DestinationPath $dst -Force

      - name: Upload artifact (ClickOnce output)
        uses: actions/upload-artifact@v4
        with:
          name: GuacamoleClient-WinForms_clickonce_${{ env.VERSION }}_anycpu
          path: bin-winforms-clickonce-${{ env.VERSION }}.zip
          if-no-files-found: error
          retention-days: 14

      ## 6) Attach ClickOnce ZIP to GitHub release
      #- name: Publish ClickOnce ZIP to the release
      #  uses: softprops/action-gh-release@v2
      #  with:
      #    files: |
      #      bin-winforms-clickonce-${{ env.VERSION }}.zip
      #    tag_name: ${{ github.event.release.tag_name || github.ref_name }}
      #  env:
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    needs: winforms-clickonce
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download ClickOnce folder artifact
        uses: actions/download-artifact@v4
        with:
          name: clickonce-folder
          path: site

      - name: Prepare Pages site (place into subdir)
        shell: bash
        run: |
          mkdir -p "public/${PAGES_SUBDIR}"
          cp -R "site/." "public/${PAGES_SUBDIR}/"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
