name: Publish/Upload dotnet package on release

# PLEASE NOTE: PUBLISHING/DEPLOYMENT
#   * Release is to be created manually at GitHub releases management page
#     * release name usually contains "1.2.3.4" (also supported: "v1.2.3.4")
#   * After creating a GitHub release, following actions will automatically run:
#     * Attaching of compiled binaries to GitHub release

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write # nötig fürs Anhängen von Assets an ein Release

env:
  BUILD_CONFIGURATION: Release
  BUILD_OUTPUT_BASEDIR1: GuacamoleClient-WinForms/bin/Debug/net8.0-windows
  BUILD_OUTPUT_BASEDIR2: GuacamoleClient-Avalonia/bin/Debug/net8.0
  BUILD_OUTPUT_BASEDIR3: GuacamoleClient-Avalonia/bin/Debug/net8.0/osx-arm64/publish
  # Wurzelordner für das MSIX-Packaging-Projekt
  MSIX_SEARCH_ROOT: WinAppPackagingMsixGuacamoleClientWinForms
  ENABLE_MSSTORE_PUBLISH: false

jobs:
  publish:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            os_id: windows
          - os: ubuntu-latest
            os_id: linux
          - os: macos-latest
            os_id: macos

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Extract version from release tag
        shell: bash
        run: |
          RAW_TAG="${{ github.event.release.tag_name || github.ref_name }}"
          VER="${RAW_TAG#v}"              # führendes "v" abschneiden, falls vorhanden
          echo "VERSION=$VER" >> "$GITHUB_ENV"
          echo "Resolved VERSION=$VER"
          echo "OS_NAME=${{ matrix.os_id }}" >> "$GITHUB_ENV"

      - name: Restore
        run: dotnet restore

      # Linux + Windows: komplette Solution inkl. MSIX-Projekt bauen
      - name: Build (WinForms + Avalonia) (Linux + Windows)
        if: runner.os != 'macOS'
        run: >
          dotnet build GuacamoleClient.sln
          --configuration ${{ env.BUILD_CONFIGURATION }}
          --no-restore
          -p:Version=${{ env.VERSION }}
          -p:FileVersion=${{ env.VERSION }}
          -p:AssemblyVersion=${{ env.VERSION }}
          -p:InformationalVersion=${{ env.VERSION }}

      # macOS: nur Avalonia, dafür RID-Publish
      - name: Publish Avalonia (macOS ARM64)
        if: runner.os == 'macOS'
        run: >
          dotnet publish GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj
          -c Debug
          -r osx-arm64
          --self-contained false
          /p:PublishSingleFile=false
          /p:IncludeNativeLibrariesForSelfExtract=false
          -p:Version=${{ env.VERSION }}
          -p:FileVersion=${{ env.VERSION }}
          -p:AssemblyVersion=${{ env.VERSION }}
          -p:InformationalVersion=${{ env.VERSION }}

      - name: Publish Avalonia (macOS Intel x64)
        if: runner.os == 'macOS'
        run: >
          dotnet publish GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj
          -c Debug
          -r osx-x64
          --self-contained false
          /p:PublishSingleFile=false
          /p:IncludeNativeLibrariesForSelfExtract=false
          -p:Version=${{ env.VERSION }}
          -p:FileVersion=${{ env.VERSION }}
          -p:AssemblyVersion=${{ env.VERSION }}
          -p:InformationalVersion=${{ env.VERSION }}

      # ZIPs bauen (Windows / Linux / macOS) – wie bisher
      - name: Pack binaries - WinForms (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $src = Join-Path $env:BUILD_OUTPUT_BASEDIR1 '*'
          $dst = Join-Path $env:GITHUB_WORKSPACE "bin-winforms-$($env:VERSION).zip"
          Compress-Archive -Path $src -DestinationPath $dst -Force

      - name: Pack binaries - Avalonia (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $src = Join-Path $env:BUILD_OUTPUT_BASEDIR2 '*'
          $dst = Join-Path $env:GITHUB_WORKSPACE "bin-avalonia-$($env:OS_NAME)-$($env:VERSION).zip"
          Compress-Archive -Path $src -DestinationPath $dst -Force

      - name: Pack binaries - Avalonia (Linux)
        if: runner.os == 'Linux'
        run: |
          (cd "${{ env.BUILD_OUTPUT_BASEDIR2 }}" && \
           zip "$GITHUB_WORKSPACE/bin-avalonia-${{ env.OS_NAME }}-${{ env.VERSION }}.zip" -r .)

      - name: Pack binaries - Avalonia - MacOS ARM64
        if: runner.os == 'macOS'
        run: |
          (cd "$BUILD_OUTPUT_BASEDIR3" && \
           zip "$GITHUB_WORKSPACE/bin-avalonia-osx-arm64-${{ env.VERSION }}.zip" -r .)

      - name: Pack binaries - Avalonia - MacOS Intel x64
        if: runner.os == 'macOS'
        run: |
          (cd "$BUILD_OUTPUT_BASEDIR3" && \
           zip "$GITHUB_WORKSPACE/bin-avalonia-osx-x64-${{ env.VERSION }}.zip" -r .)

      # NEU: MSIX / AppX Paket einsammeln (nur Windows-Job)
      - name: Collect MSIX package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $searchRoot = Join-Path $env:GITHUB_WORKSPACE $env:MSIX_SEARCH_ROOT
          Write-Host "Searching for MSIX/AppX artifacts under $searchRoot"

          $msix = Get-ChildItem -Path $searchRoot -Recurse `
                    -Include *.msix,*.msixbundle,*.msixupload,*.appx,*.appxbundle,*.appxupload `
                    | Select-Object -First 1

          if (-not $msix) {
            Write-Error "No MSIX/AppX package found under $searchRoot"
          }

          $targetName = "GuacamoleClient-WinForms-msix-$($env:VERSION)$($msix.Extension)"
          $dst = Join-Path $env:GITHUB_WORKSPACE $targetName

          Copy-Item $msix.FullName $dst -Force
          Write-Host "MSIX/AppX package copied to $dst"

          # Name für nachfolgende Steps im Environment hinterlegen
          "MSIX_FILE=$targetName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # Assets an Release anhängen
      - name: Publish binaries to the release (Windows)
        if: runner.os == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin-winforms-${{ env.VERSION }}.zip
            bin-avalonia-${{ env.OS_NAME }}-${{ env.VERSION }}.zip
            ${{ env.MSIX_FILE }}
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish binaries to the release (Linux)
        if: runner.os == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin-avalonia-${{ env.OS_NAME }}-${{ env.VERSION }}.zip
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish binaries to the release (macOS)
        if: runner.os == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin-avalonia-osx-arm64-${{ env.VERSION }}.zip
            bin-avalonia-osx-x64-${{ env.VERSION }}.zip
          tag_name: ${{ github.event.release.tag_name || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Microsoft Store Developer CLI installieren (offizielle Action von Microsoft)
      - name: Setup Microsoft Store CLI
        if: runner.os == 'Windows' && env.ENABLE_MSSTORE_PUBLISH == 'true'
        uses: microsoft/microsoft-store-apppublisher@v1.1

      # CLI mit Ihren Partner-Center-Credentials konfigurieren (aus GitHub-Secrets)
      - name: Configure Microsoft Store CLI
        if: runner.os == 'Windows' && env.ENABLE_MSSTORE_PUBLISH == 'true'
        shell: pwsh
        run: |
          msstore reconfigure `
            --tenantId    "${{ secrets.PARTNER_CENTER_TENANT_ID }}" `
            --sellerId    "${{ secrets.PARTNER_CENTER_SELLER_ID }}" `
            --clientId    "${{ secrets.PARTNER_CENTER_CLIENT_ID }}" `
            --clientSecret "${{ secrets.PARTNER_CENTER_CLIENT_SECRET }}"

      # MSIX-Paket über die CLI an den Microsoft Store übergeben
      - name: Publish MSIX to Microsoft Store
        if: runner.os == 'Windows' && env.ENABLE_MSSTORE_PUBLISH == 'true'
        shell: pwsh
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $packagePath = Join-Path $workspace $env:MSIX_FILE

          Write-Host "Publishing MSIX package $packagePath to Microsoft Store..."

          # Falls Sie 'msstore init' im Repo ausgeführt und committed haben,
          # reicht der Projektpfad als erstes Argument.
          msstore publish $workspace -i "$packagePath"
