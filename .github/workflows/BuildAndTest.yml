name: Build and Test

# PREREQUISITES FOR PUSH-BACK OF TEST RESULTS
# Please note: test project usually required nuget package JUnitTestLogger 
# to be able to provide JUnit compatible test results XML file (required 
# for pushing back details on succeeded/failed tests)
# 
# NuGet install command:
# - Install-Package JUnitTestLogger

# Controls when the action will run.
on:
    # Triggers the workflow on push or pull request events but only for the master branch
    push:
        branches: [main]
    pull_request:
        branches: [main]

    # Allows you to run this workflow manually from the Actions tab
    workflow_dispatch:

env:
  # Path to the solution file relative to the root of the project
  SOLUTION_FILE_PATH: .

  # Configuration type to build
  BUILD_CONFIGURATION: CI_CD

  BUILD_OUTPUT: GuacamoleClient/bin/Debug
  RESULTS_PATH: TestResults.xml
  
jobs:

    test:
        #needs: build
        runs-on: ${{ matrix.os }}

        strategy:
          fail-fast: false
          matrix:
            os: [windows-latest, ubuntu-latest, macos-latest]
            include: 
              - os: macos-latest
                runNetExe: mono

        # the build-and-test job might be skipped, we don't need to run this job then
        #if: success() || failure()

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET Core
              uses: actions/setup-dotnet@v4
              with:
                 dotnet-version: 8.0.x

            - name: Dir Listing (Win)
              if: startsWith(matrix.os, 'windows')
              run: dir
            - name: Dir Listing (Linux/Mac)
              if: (!startsWith(matrix.os, 'windows'))
              run: ls -la

            - name: Install dependencies
              run: dotnet restore

            - name: Build (Win/Linux)
              if: always() && (!(startsWith(matrix.os, 'macos')))
              run: dotnet build --configuration=${{env.BUILD_CONFIGURATION}} --no-restore

            #DISABLED dotnet build for Mac due to missing files during build
            #/Users/runner/.dotnet/sdk/10.0.101/Microsoft.Common.CurrentVersion.targets(5381,5): error MSB3030: Could not copy the file "/Users/runner/work/GuacamoleClient/GuacamoleClient/GuacamoleClient-Avalonia/bin/CI_CD/net8.0/libGLESv2.dylib" because it was not found. [/Users/runner/work/GuacamoleClient/GuacamoleClient/GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj]
            #/Users/runner/.dotnet/sdk/10.0.101/Microsoft.Common.CurrentVersion.targets(5381,5): error MSB3030: Could not copy the file "/Users/runner/work/GuacamoleClient/GuacamoleClient/GuacamoleClient-Avalonia/bin/CI_CD/net8.0/libEGL.dylib" because it was not found. [/Users/runner/work/GuacamoleClient/GuacamoleClient/GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj]
            #/Users/runner/.dotnet/sdk/10.0.101/Microsoft.Common.CurrentVersion.targets(5381,5): error MSB3030: Could not copy the file "/Users/runner/work/GuacamoleClient/GuacamoleClient/GuacamoleClient-Avalonia/bin/CI_CD/net8.0/libvk_swiftshader.dylib" because it was not found. [/Users/runner/work/GuacamoleClient/GuacamoleClient/GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj]
            #- name: Build (Mac)
            #  if: always() && ((startsWith(matrix.os, 'macos')))
            #  run: dotnet build GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj --configuration=${{env.BUILD_CONFIGURATION}} --no-restore
            #
            #INSTEAD: dotnet public works on Mac
            # macOS: RID-Publish für die Avalonia-App (zieht CEF-Natives)
            - name: Publish Avalonia (macOS, osx-arm64)
              if: matrix.os == 'macos-latest'
              run: >
                dotnet publish
                GuacamoleClient-Avalonia/GuacamoleClient-Avalonia.csproj
                -c Debug
                -r osx-arm64
                --self-contained false
                /p:PublishSingleFile=false
                /p:IncludeNativeLibrariesForSelfExtract=false

            - name: Run Unit Tests
              run: dotnet test -v n --results-directory test-results --logger junit --configuration=${{env.BUILD_CONFIGURATION}} --no-restore

            - name: Unit Test Results (Linux)
              uses: EnricoMi/publish-unit-test-result-action@v2
              if: always() && startsWith(matrix.os, 'ubuntu')
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  files: "test-results/TestResults.xml"
                  check_run_annotations: all tests
                  comment_title: Unit Test Statistics (${{matrix.os}})
                  check_name: Unit Test Results (${{matrix.os}})
                  report_individual_runs: true

            - name: Unit Test Results (Win)
              uses: EnricoMi/publish-unit-test-result-action/composite@v2
              if: always() && startsWith(matrix.os, 'windows')
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  files: "test-results/TestResults.xml"
                  check_run_annotations: all tests
                  comment_title: Unit Test Statistics (${{matrix.os}})
                  check_name: Unit Test Results (${{matrix.os}})
                  report_individual_runs: true

            - name: Publish Unit Test Results (.NET Core)
              uses: actions/upload-artifact@v4
              if: always() && (!(startsWith(matrix.os, 'macos')))
              with:
                  name: NUnit Test Results ${{ matrix.os }}
                  path: test-results/TestResults.xml
